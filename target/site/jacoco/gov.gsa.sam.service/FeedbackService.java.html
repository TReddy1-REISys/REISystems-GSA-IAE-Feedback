<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FeedbackService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Feedback Manager</a> &gt; <a href="index.source.html" class="el_package">gov.gsa.sam.service</a> &gt; <span class="el_source">FeedbackService.java</span></div><h1>FeedbackService.java</h1><pre class="source lang-java linenums">package gov.gsa.sam.service;

import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Optional;
import java.util.Set;

import org.apache.commons.lang.StringEscapeUtils;
import org.apache.commons.lang.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import gov.gsa.sam.domain.Feedback;
import gov.gsa.sam.domain.ResponseContent;
import gov.gsa.sam.exception.BaseApplicationException;
import gov.gsa.sam.repository.FeedbackRepository;
import gov.gsa.sam.utilities.Constants;

/**
 * The Feedback Service contains the business logic for working with Feedback
 * Details
 *
 * @version 1.0
 * @author Nithin John Emanuel
 */

@Service
<span class="fc" id="L32">public class FeedbackService {</span>

<span class="fc" id="L34">	private static final Logger log = LoggerFactory.getLogger(FeedbackService.class);</span>

	@Autowired
	private FeedbackRepository feedbackRepo;

	/**
	 * This method fetches all the feedback from the database
	 * 
	 * @return List&lt;Feedback&gt;
	 * @throws BaseApplicationException
	 */
	public List&lt;Feedback&gt; getAllFeedback(Timestamp feedbackDate) throws BaseApplicationException {
<span class="fc" id="L46">		log.info(&quot;Service gets all the feedback details&quot;);</span>
<span class="fc" id="L47">		List&lt;Feedback&gt; allFeedback = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L48" title="1 of 2 branches missed.">		if (feedbackDate == null) {</span>
<span class="fc" id="L49">			allFeedback = feedbackRepo.getAllFeedback();</span>
		} else {
<span class="nc" id="L51">			allFeedback = feedbackRepo.getAllFeedbackByDate(feedbackDate);</span>
		}

<span class="fc" id="L54">		return allFeedback;</span>
	}

	/**
	 * This method fetches feedback detail for the provided Id
	 * 
	 * @param feedbackId
	 * @return Feedback
	 * @throws BaseApplicationException
	 */
	public Feedback getFeedbackById(Long feedbackId) throws BaseApplicationException {
<span class="fc" id="L65">		log.info(&quot;Service gets detail of feedback for the Id &quot; + feedbackId);</span>
<span class="fc" id="L66">		Feedback feedback = feedbackRepo.getFeedbackById(feedbackId);</span>
<span class="fc" id="L67">		return feedback;</span>
	}

	/**
	 * This method fetches all the feedback details for the provided ids
	 * 
	 * @param feedbackIds
	 * @return List&lt;Feedback&gt;
	 * @throws BaseApplicationException
	 */
	public List&lt;Feedback&gt; getAllFeedback(String feedbackIds, Timestamp feedbackDate) throws BaseApplicationException {
<span class="fc" id="L78">		log.info(&quot;Service gets details of feedback for the following ids &quot; + feedbackIds);</span>
<span class="fc" id="L79">		feedbackIds = feedbackIds.replaceAll(&quot;\\s+&quot;, &quot;&quot;);</span>

<span class="fc" id="L81">		String[] ids = feedbackIds.split(&quot;,&quot;);</span>
<span class="fc" id="L82">		Set&lt;Long&gt; feedbackIdSet = new HashSet&lt;Long&gt;();</span>

<span class="fc bfc" id="L84" title="All 2 branches covered.">		for (String id : ids) {</span>
<span class="pc bpc" id="L85" title="1 of 2 branches missed.">			if (StringUtils.isNumeric(id)) {</span>
<span class="fc" id="L86">				feedbackIdSet.add(Long.parseLong(id));</span>
			}
		}

<span class="fc" id="L90">		List&lt;Feedback&gt; feedbackList = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">		if (feedbackDate == null) {</span>
<span class="fc" id="L92">			feedbackList = feedbackRepo.getAllFeedbackByIds(feedbackIdSet);</span>
		} else {
<span class="nc" id="L94">			feedbackList = feedbackRepo.getAllFeedbackByIdsAndDate(feedbackIdSet, feedbackDate);</span>
		}

<span class="fc" id="L97">		return feedbackList;</span>
	}

	/**
	 * This method is used to persist all the Feedback to the database
	 * 
	 * @param responseContent
	 * @return
	 * @throws BaseApplicationException
	 */
	public List&lt;Feedback&gt; createFeedback(ResponseContent responseContent) throws BaseApplicationException {
<span class="fc" id="L108">		Timestamp currTime = new Timestamp(System.currentTimeMillis());</span>

<span class="fc" id="L110">		List&lt;Feedback&gt; savedList = new ArrayList&lt;Feedback&gt;();</span>

		try {
<span class="fc bfc" id="L113" title="All 2 branches covered.">			for (Feedback feedback : responseContent.getFeedbackList()) {</span>
<span class="fc" id="L114">				feedback.setFeedbackPath(responseContent.getFeedbackPath());</span>
<span class="fc" id="L115">				feedback.setUserId(responseContent.getUserId());</span>
<span class="fc" id="L116">				feedback.setCreatedBy(Constants.ADMIN);</span>
<span class="fc" id="L117">				feedback.setCreatedDate(currTime);</span>
<span class="fc" id="L118">				feedback.setLastmodifiedBy(Constants.ADMIN);</span>
<span class="fc" id="L119">				feedback.setLastmodifiedDate(currTime);</span>

				// Escaping HTML and Javascript for XSS*******
<span class="fc" id="L122">				List&lt;String&gt; selectedList = feedback.getFeedbackResponse().getSelected();</span>
<span class="fc" id="L123">				List&lt;String&gt; newSelectedList = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L124" title="All 2 branches covered.">				for (String selected : selectedList) {</span>
<span class="fc" id="L125">					newSelectedList.add(StringEscapeUtils.escapeJavaScript(StringEscapeUtils.escapeHtml(selected)));</span>
<span class="fc" id="L126">				}</span>
<span class="fc" id="L127">				feedback.getFeedbackResponse().setSelected(newSelectedList);</span>
				// Escaping HTML and Javascript for XSS*******

<span class="fc" id="L130">				Feedback savedFeedback = feedbackRepo.saveAndFlush(feedback);</span>
<span class="fc" id="L131">				savedList.add(savedFeedback);</span>
<span class="fc" id="L132">			}</span>
<span class="fc" id="L133">			log.info(&quot;Successful to persist all the feedback to DB &quot;);</span>
<span class="fc" id="L134">			return savedList;</span>
<span class="fc" id="L135">		} catch (Exception e) {</span>
<span class="fc" id="L136">			log.error(&quot;Error while persisting feedbacks to database &quot;, e);</span>
<span class="fc" id="L137">			return savedList;</span>
		}
	}

	/**
	 * This method is used to update a Feedback
	 * 
	 * @param feedbackId
	 * @param feedback
	 * @return Feedback
	 * @throws BaseApplicationException
	 */
	public Feedback updateFeedback(Long feedbackId, Feedback feedback) throws BaseApplicationException {
<span class="fc" id="L150">		Timestamp currTime = new Timestamp(System.currentTimeMillis());</span>
<span class="fc" id="L151">		Optional&lt;Feedback&gt; feedbackOpt = feedbackRepo.findById(feedbackId);</span>
<span class="fc" id="L152">		Feedback dbFeedback = null;</span>
<span class="pc bpc" id="L153" title="1 of 2 branches missed.">		if (feedbackOpt.isPresent()) {</span>
<span class="fc" id="L154">			dbFeedback = feedbackOpt.get();</span>
		}

		Feedback savedFeedback;

<span class="pc bpc" id="L159" title="1 of 2 branches missed.">		if (dbFeedback != null) {</span>
<span class="fc" id="L160">			dbFeedback.setLastmodifiedBy(Constants.ADMIN);</span>
<span class="fc" id="L161">			dbFeedback.setLastmodifiedDate(currTime);</span>
<span class="fc" id="L162">			dbFeedback.setFeedbackResponse(feedback.getFeedbackResponse());</span>
<span class="fc" id="L163">			dbFeedback.setQuestionId(feedback.getQuestionId());</span>
<span class="fc" id="L164">			dbFeedback.setUserId(feedback.getUserId());</span>
<span class="fc" id="L165">			dbFeedback.setFeedbackPath(feedback.getFeedbackPath());</span>

<span class="fc" id="L167">			savedFeedback = feedbackRepo.saveAndFlush(dbFeedback);</span>
<span class="fc" id="L168">			log.info(&quot;Feedback Id -&quot; + feedbackId + &quot; was successfully updated&quot;);</span>
		} else {
<span class="nc" id="L170">			log.info(&quot;Feedback Id : &quot; + feedbackId + &quot; is not present in the DB!!&quot;);</span>
<span class="nc" id="L171">			throw new BaseApplicationException(&quot;Feedback Id :: &quot; + feedbackId + &quot; is not present in the DB!!&quot;);</span>
		}

<span class="fc" id="L174">		return savedFeedback;</span>
	}

	public List&lt;Feedback&gt; getAllFeedbackReport() {
<span class="fc" id="L178">		log.info(&quot;Service gets all the feedback details&quot;);</span>
<span class="fc" id="L179">		List&lt;Feedback&gt; allFeedback = feedbackRepo.getAllFeedbackReport();</span>
<span class="fc" id="L180">		return allFeedback;</span>
	}

	/**
	 * This method is used to delete feedback from DB
	 * 
	 * @param feedbackId
	 * @return String
	 */
	public String deleteFeedback(Long feedbackId) {
		try {
<span class="fc" id="L191">			feedbackRepo.deleteById(feedbackId);</span>
<span class="fc" id="L192">			log.info(&quot;Successful to delete feedback Id &quot; + feedbackId);</span>
<span class="fc" id="L193">			return &quot;Successful&quot;;</span>
<span class="nc" id="L194">		} catch (Exception e) {</span>
			// TODO Auto-generated catch block
<span class="nc" id="L196">			log.info(&quot;Error in deleting the feedback Id &quot; + feedbackId + &quot; &quot; + e.getMessage());</span>
<span class="nc" id="L197">			log.error(&quot;Error in deleting the feedback&quot;, e);</span>
<span class="nc" id="L198">			return &quot;Failure&quot;;</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.0.201801022044</span></div></body></html>